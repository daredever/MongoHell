## Welcome part

*Дима:*

Добрый день, друзья, рады приветствовать Вас на 58 встрече Петербургского .net сообщества, проходящей в коллаборации с Центром Речевых Технологий. 
Меня зовут Елисеев Дмитрий, я занимаюсь базами данных в ЦРТ. 

*Рома:*

Меня зовут Роман Щербаков, и я занимаюсь разработкой бэк-енда в ЦРТ и мы хотели бы рассказать Вам о внедрении MongoDB в .net проект. 

*Дима:*

Рассказ об обследовании проекта.
И так, почему же MongoDB? Придя на новый проект, я начал анализировать чем он живёт, какие перспективы, какие технологии используются.
Одной из первых задач которая мне прилетела была - тормозит postgtres.
Углубившись в суть проблемы, я обнаружил, что тормозит поиск по json документу,
Имея за спиной понимание, что для таких целеЙ гораздо лучше подходит Mongo, я решился на попытку её внедрения 
И именно в этот момент начинается "Божественная комедия" внедрения MongoDB в .net проект.

Раскрыть тему кругов (тут слайд с картинкой данте).

#  Circles of Hell

## 1 круг - Лимб. 

*Дима:*

- Предложение внедрить монгу. 
Когда я подошёл к архитектору нашего проекта с вопросом, а почему собственно не Mongo? 
Я услышал стандартные ответы:
- она не стабильна
- у нас был опыт использования, но он оказался неудачным
- нет транзакций
- течёт память

Железобетонные аргументы, через которые казалось бы не пробиться.
Однако, понимая что постгрес не даст таких же показателей перформанса как Mongo,
я решил обратиться к ресёрчу который проводился к 51 встрече, и на примере документов с ссылкой
и документа в документе показал, что по производительности mongoDB выигрывает у пг.

 
Бенчмарки производительности для любого руководства  всегда выглядят весомо. 
Простота репликации и шардирования, не требующая глубокого понимания принципов работы БД 
Отсутствие жёсткой схемы данных(если надо, то можно настроить), если Вы работаете с динамически изменяемой структурой объекта, это то, что Вам нужно. Ну и естественно бесплатность использования

Показав все достоинства, и когда они взяты во внимание, мы переходим ко второму кругу

_Вывод - у монги много плюсов._

## 2 круг - Сладострастие.

*Дима:* 

Проанализировав проект, и поняв что большинство сервисов хранит jobject в пг,
и воодушевившись показателями синтетик тестов сразу чешутся руки творить добро и справедливость,
и воткнуть монго везде, но эта эйфория обманчива
Если есть сервис аутентификации, и его работа с ролями, пользователями и сессиями вполне себе реляционна, и работает он стабильно и быстро, то трудозатраты по переезду на монгу явно не окупятся профитом.
Но если говорить об остальных сервисах, то часть разработчиков как всегда занята допиливанием фич,
часть на баг-фиксинге. Естественно выцепить ресурсы у руководства под рефакторинг довольно сложно.
Нужна была такая подсистема, которая не заденет ядро системы, и  тем не менее сможет показать профит от технологии
В нашем случае выбор пал на импорт из внешних систем и вот почему
- Данные могут приходить в каком угодно формате
- Схема данных заранее неизвестна
- Необходима высокая скорость записи и чтения

Когда мною был продуман принцип работы сервиса внешней интеграции, получено разрешение архитектора творить под мою ответственность, я пришёл к Роме, и тут начался третий круг

_Вывод - начать с малого._

## 3 круг - Чревоугодие.  (live coding)

*Рома:*

- Реализация стандартного  ETL процесса: source - mongodb - destination. 
- Поднимаем stadlalone. Поясняем Connection string. mongodb://host:21017/ - это вот все.
- Простота использования (Пример репозитория CRUD).
- Отсутствие схемы (автоматическое создание базы и коллекций). 
- Хранение конфигурации для импорта - отказ от файлов конфигураций. 
- Проливаем данные из текстовика (надо придумать что льем, что было бы как то связано с адом например)
- Перфоманс из коробки.

(Тут картинки с временем выполнения запросов)

_Вывод - все просто._

## 4 круг - Жадность.

*Дима:*

Глядя на результат, как красиво у нас бегут и обрабатываются данные в многопоточке,
мы с чистой душой, думая что всё настроили и дописали сервис отдаем его в нагрузочное тестирование,
рассказывая о том какая монго крутая, и что время ответа в 0.1ms она сама считает медленным...

И тут получаем статистику.
Которая идёт в разрез со всем, что мы видели.
Да, первое время на малом объёме данных монго работает великолепно, но по мере увеличения количества документов в ней
она деградирует в ответах, и начинает потреблять cpu за себя, да и за все остальные сервисы.
Пиковая нагрузка выдавалаа 10 из 12 ядер стенда в потолок, и ответ от 300мс до нескольких секунд
Вопрос стал на столько остро, что нам было сказано, если вы не найдёте ответ до конца спринта, мы отказываемся от монго в принципе.
И наша небольшая команда стала ломать голову, в чём же проблема.
Добавили профилирование в код, чтобы понимать где конкретно происходят тормоза
Снова убедились что тормозит исключительно MongoDB...
Если честно, уже не вспомнить всех теорий заговора которые мы тогда придумывали, пытаясь понять что же происходит.
Я вспомнил, что в MS SQL сервере происходит деградация записи если довольно крупный кластерный индекс.
И тут нас всех озарило
По коллекции просто идёт фулскан. Оказывается MongoDB обычная база данных, и никакой магии не существует.
Хотя, пожалуй немного её было, стоило создать индекс по полю фильтрации, на сервере моментально наступилп тищина, и Mongo потребляла не более положеных для себя 50-70% cpu

_Вывод - не все так просто._

## 5 круг - Гнев и лень.  (live coding)

*Дима:*

- deploy: standalone => replica set => sharded cluster (yaml config)
- mongod + mongos.
- MongoShell. Обратить внимание на перенос строк \n и ограниченную длину строки (не все документы помещаются)
- Генераторы данных. Генераторы индексов.
- Проверка отказоусточивости

_Вывод - не все гладко, но дорогу осилит идущий._


## 6 круг - Для еретиков и лжеучителей.

*Рома:*

- Решились сменить БД перед релизом во избежание миграций.
Централизация использования технологий.
- Проблемы реляционного мышления при работе с noSQL(человеческий фактор).
Я сам .net разработчик с бэкграундом MS SQL SERVER и что я не понимал.
- collection != table
- Хранение произвольных объектов в одной коллекции 
(Разные документы в одной коллекции, транзакции частно не нужны - можно хранить все в одном документе).

(тут картинка - несколько таблиц превращаются в одну коллекцию)

_Вывод - надо заранее готовить аргументы и примеры для разработчиков._

## 7 круг - Для насильников и убийц всех мастей.

*Дима:*

- Измения в архитектуре.
- Высокая трудоемкость при проектировании - plain-table перевести просто, остальное сложно и требуется переработка. 
- Ограничение на размер (16мб) и глубину документа (1000).
- Переписываем реализацию старых(реляционных) репозиториев.
- Анализ индексов.

_Вывод - надо аккуратно проектировать._

## 8 круг - Для обманувших недоверившихся. (live coding)
! это относится к разработчикам монго-клиента !

*Рома:*

- А теперь про боль и страдания (Технические проблемы и трудности при переходе на MongoDB).
- Выделение отдельной сущности для singleton MongoClient (dispose? как освобождать ресурсы?).
- Непривычная фильтрация - вкусовщина, кому-то нравится, кому-то нет. Проблемы с лямбдами.
- Сериализация. BSON документ (произвольные иерархические структуры данных) и простота сериализации. JObject отсутствует из коробки. BsonIgnore.
- Транзакции - основы работы.
- Нет атрибутов для индексов, кроме BsonId.
- Особенности работы с индексами при построении запросов - один индекс на запрос (поискать hint в монго-клиенте).

_Вывод - сначала лучше попробовать вручную поработать через mongoshell._

## 9 круг - Для отступников и предателей всех сортов.

*Рома:*

Проблемы выявленные при тестировании.
- Проблемы с поиском по датам (фильтры, непонимание DSL).
- Проблемы с UI для администрирования данных.
- Проблемы сериализации (DateTimeOffset и GUID). 
- Проблема версий пакета Mongo.Bson и необходимость Unit тестов на сериализацию/десериализацию.
- Проблема с транзакциями (работают только в режиме кластера)

_Вывод - BSON это гибкость, но сериализация требует особого внимания._

## Дорога к раю.

*Дима:*

Или почему MongoDB осталась основным хранилищем данных в проекте.

Производительность + нет миграций + отказоусточивость + стоимость.

### FAQ

### Ссылки и контакты



















