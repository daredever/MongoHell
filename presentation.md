## Welcome part

*Дима:*

Добрый день, друзья, рады приветствовать Вас на 58 встрече Петербургского .net сообщества, проходящей в коллаборации с Центром Речевых Технологий. 
Меня зовут Елисеев Дмитрий, я занимаюсь базами данных в ЦРТ. 

*Рома:*

Меня зовут Роман Щербаков, и я занимаюсь разработкой бэк-енда в ЦРТ и мы хотели бы рассказать Вам о внедрении MongoDB в .net проект. 
Обычно принято заранее показывать агенду, но мы намеренно не будем показывать вам оглавление нашего доклада, а почему, Вы поймёте чуть позже.

*Дима:*

Рассказ об обследовании проекта.
И так, почему же MongoDB? Придя на новый проект, я начал анализировать чем он живёт, какие перспективы, какие технологии используются. 
Наткнулся на хранение json в postgresql, учитывая ресёрч который был проведён в рамках подготвки к докладу 51 встречи который вы 
можете посмотреть на youtube канале сообщества, решил. Раз уж мы храним объекты в базе, Надо внедрить MongoDB. 
И именно в этот момент начинается "Божественная комедия" внедрения MongoDB в .net проект.

Раскрыть тему кругов (тут слайд с картинкой данте).

#  Circles of Hell

## 1 круг - Лимб. 

*Дима:*

- Предложение внедрить монгу. 
Когда я подошёл к архитектору нашего проекта с вопросом, а почему собственно не Mongo? 
Я услышал стандартные ответы: она не стабильна, у нас был опыт использования, но он оказался неудачным, нет транзакций... 
И всё в таком духе. Но, мне повезло, мне было сказано, если ты сможешь доказать что эту технологию можно 
использовать адекватно, то можно рискнуть её внедрить.

- Как продать архитекторам и руководству (Спросить архитекторов, почему они согласились.). 

- Каковы были мои аргументы? 
Бенчмарки производительности, для любого руководства высокий перформанс всегда выглядит весомо. 
Простота репликации и шардирования, не требующая глубокого понимания 
Отсутствие жёсткой схемы данных(если надо, то можно настроить), если Вы работаете с динамически изменяемой структурой объекта, это то, что Вам нужно.

- Можно конечно долго перечислять способы убеждения вышестоящих, но подытожить это можно следующим:

    1. Перформанс
    1. Простота инеграции технологии в экосистему
    1. Отказоустойчивость (кластер).
    1. Рациональность использования данной технологии (Естественно если технология бесплатна, это сделать будет ещё проще)

(добавить плюсы и минусы)

_Вывод - у монги много плюсов._

## 2 круг - Сладострастие.

*Дима:* 

- Как побороть желание воткнуть технологию повсеместно, и использовать её только по назначению.
- Решение внедрять технологию постепенно. 
- Выбор задачи (Выбрать что-то одно, обкатать на отдельной задаче "рядом" с основной системой).
Выбор пал на импорт из внешних систем.

_Вывод - начать с малого._

## 3 круг - Чревоугодие.  (live coding)

*Рома:*

- Реализация стандартного  ETL процесса: source - mongodb - destination. 
- Поднимаем stadlalone. Поясняем Connection string. mongodb://host:21017/ - это вот все.
- Простота использования (Пример репозитория CRUD).
- Отсутствие схемы (автоматическое создание базы и коллекций). 
BSON документ (произвольные иерархические структуры данных) и простота сериализации.
- Хранение конфигурации для импорта - отказ от файлов конфигураций. 
- Проливаем данные из текстовика (надо придумать что льем, что было бы как то связано с адом например)
- Перфоманс из коробки.

(Тут картинки с временем выполнения запросов)

_Вывод - все просто._

## 4 круг - Жадность.

*Дима:*

- Нагрузка данными - зажравшаяся монга.
- Быстрая деградация.
- Поняли что не все так просто. Необходимость индексов.
- (Тут картинки про рост времени выполнения запросов, таблички с количеством чтений индексов)

_Вывод - не все так просто._

## 5 круг - Гнев и лень.  (live coding)

*Дима:*

- deploy: standalone => replica set => sharded cluster (yaml config)
- mongod + mongos.
- MongoShell. Обратить внимание на перенос строк \n и ограниченную длину строки (не все документы помещаются)
- Генераторы данных. Генераторы индексов.
- Проверка отказоусточивости

_Вывод - не все гладко, но дорогу осилит идущий._


## 6 круг - Для еретиков и лжеучителей.

*Рома:*

- Решились сменить БД перед релизом во избежание миграций.
Централизация использования технологий.
- Проблемы реляционного мышления при работе с noSQL(человеческий фактор).
Я сам .net разработчик с бэкграундом MS SQL SERVER и что я не понимал.
- collection != table
- Хранение произвольных объектов в одной коллекции 
(Разные документы в одной коллекции, транзакции частно не нужны - можно хранить все в одном документе).

(тут картинка - несколько таблиц превращаются в одну коллекцию)

_Вывод - надо заранее готовить аргументы и примеры для разработчиков._

## 7 круг - Для насильников и убийц всех мастей.

*Дима:*

- Измения в архитектуре.
- Высокая трудоемкость при проектировании - plain-table перевести просто, остальное сложно и требуется переработка. 
- Ограничение на размер (16мб) и глубину документа (1000).
- Переписываем реализацию старых(реляционных) репозиториев.
- Анализ индексов.

_Вывод - надо аккуратно проектировать._

## 8 круг - Для обманувших недоверившихся. (live coding)
! это относится к разработчикам монго-клиента !

*Рома:*

- А теперь про боль и страдания (Технические проблемы и трудности при переходе на MongoDB).
- Выделение отдельной сущности для singleton MongoClient (dispose? как освобождать ресурсы?).
- Непривычная фильтрация - вкусовщина, кому-то нравится, кому-то нет. Проблемы с лямбдами.
- Сериализация. JObject отсутствует из коробки. BsonIgnore.
- Транзакции - основы работы.
- Нет атрибутов для индексов, кроме BsonId.
- Особенности работы с индексами при построении запросов - один индекс на запрос (поискать hint в монго-клиенте).

_Вывод - сначала лучше попробовать вручную поработать через mongoshell._

## 9 круг - Для отступников и предателей всех сортов.

*Рома:*

Проблемы выявленные при тестировании.
- Проблемы с поиском по датам (фильтры, непонимание DSL).
- Проблемы с UI для администрирования данных.
- Проблемы сериализации (DateTimeOffset и GUID). 
- Проблема версий пакета Mongo.Bson и необходимость Unit тестов на сериализацию/десериализацию.
- Проблема с транзакциями (работают только в режиме кластера)

_Вывод - BSON это гибкость, но сериализация требует особого внимания._

## Дорога к раю.

*Дима:*

Или почему MongoDB осталась основным хранилищем данных в проекте.

Производительность + нет миграций + отказоусточивость + стоимость.

### FAQ

### Ссылки и контакты



















